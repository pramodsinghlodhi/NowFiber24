rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Function to get the user's role from their profile in the 'users' collection
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Function to check if the user is an Admin
    function isAdmin() {
      return getUserRole() == 'Admin';
    }

    // Function to check if the user is a Technician
    function isTechnician() {
      return getUserRole() == 'Technician';
    }

    // Function to check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users can only read their own profile. Admins can read all profiles.
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow write: if isAdmin(); // Only admins can create/update user profiles through backend functions
    }

    // Technicians can update their own document, Admins can read all.
    match /technicians/{techId} {
      allow read: if isAuthenticated();
      // A technician can only update their own document, and only specific fields.
      allow update: if (request.auth.uid == get(/databases/$(database)/documents/users/{userId} where 'id' == techId)[0].data.uid) && (request.resource.data.keys().hasOnly(['lat', 'lng', 'isActive', 'status']));
      allow write: if isAdmin(); // Admins have full write access
    }

    // Authenticated users can read tasks, alerts, infrastructure, connections, materials
    match /{collection}/{docId} 
        where collection in ['tasks', 'alerts', 'infrastructure', 'connections', 'materials', 'assignments', 'referrals', 'proofOfWork', 'plans', 'contacts'] {
      allow read: if isAuthenticated();
      allow write: if isAdmin(); // Only Admins can write
    }
    
    // Notifications: Users can only access their own notifications
    match /users/{userId}/notifications/{notificationId} {
        allow read, write: if request.auth.uid == userId;
    }

    // Settings can only be read and written by Admins
    match /settings/live {
        allow read, write: if isAdmin();
    }
  }
}