
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for Admin role via custom claims
    function isAdmin() {
      return request.auth.token.isAdmin == true;
    }

    // Helper function to check if the user is a Technician
    function isTechnician() {
        return request.auth.token.role == 'Technician';
    }

    // Helper function to check if the user is the owner of the resource
    // (Used for technician-specific data)
    function isOwner(userId) {
        return request.auth.uid == userId;
    }
    
    //------------------------------------------------------------
    // Users Collection Rules
    //------------------------------------------------------------
    match /users/{userId} {
      // Admins can manage any user document
      allow read, write: if isAdmin();
      // Authenticated users can read their own profile
      allow get: if request.auth.uid == userId;
      // Allow user to update their own profile, but not change their role
      allow update: if request.auth.uid == userId 
                    && request.resource.data.role == resource.data.role;
    }

    //------------------------------------------------------------
    // Notifications Sub-collection Rules
    //------------------------------------------------------------
    match /users/{userId}/notifications/{notificationId} {
        // A user can read and manage their own notifications
        allow read, write, delete: if isOwner(userId);
        // Admins can also manage notifications (e.g., for system-wide broadcasts)
        allow write: if isAdmin();
    }
    
    //------------------------------------------------------------
    // Settings Collection Rules
    //------------------------------------------------------------
    match /settings/{settingId} {
        // Only Admins can read or write to the settings document
        allow read, write: if isAdmin();
    }

    //------------------------------------------------------------
    // Public/Semi-Public Read Rules
    // Admins can read/write everything. Technicians need broad read access.
    //------------------------------------------------------------
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    match /technicians/{techId} {
        allow read: if isTechnician();
        // A technician can update their own status/location
        allow update: if isTechnician() && request.auth.token.userId == techId;
    }

    match /tasks/{taskId} {
        allow read: if isTechnician();
        // Technicians can update tasks assigned to them
        allow update: if isTechnician() && resource.data.tech_id == request.auth.token.userId;
    }

    match /materials/{materialId} {
        allow read: if isTechnician();
    }
    
    match /infrastructure/{infraId} {
        allow read: if isTechnician();
    }

    match /connections/{connId} {
        allow read: if isTechnician();
    }
    
    match /alerts/{alertId} {
        allow read: if isTechnician();
    }

    //------------------------------------------------------------
    // Technician-Specific Write Rules
    //------------------------------------------------------------

    match /assignments/{assignmentId} {
        allow read: if isTechnician();
        // Technicians can create new material requests (assignments)
        allow create: if isTechnician();
    }

    match /referrals/{referralId} {
        allow read: if isTechnician();
        // Technicians can create new referrals
        allow create: if isTechnician();
    }

    match /proofOfWork/{proofId} {
        // Technicians can create new proof of work submissions
        allow create: if isTechnician();
    }
  }
}
