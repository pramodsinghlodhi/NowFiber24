rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get user data from the 'users' collection
    function getUserData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }

    // Helper function to check if the user is an Admin
    function isAdmin() {
      return isAuthenticated() && getUserData(request.auth.uid).role == 'Admin';
    }
    
    // Helper function to check if the user's account is active
    function isNotBlocked() {
        return isAuthenticated() && getUserData(request.auth.uid).isBlocked == false;
    }

    // Helper function to check if the user is a Technician
    function isTechnician() {
      return isAuthenticated() && isNotBlocked() && getUserData(request.auth.uid).role == 'Technician';
    }

    // Default deny all access
    match /{document=**} {
      allow read, write: if false;
    }

    // Admin Access: Admins can read and write everything.
    // This is a broad but simple rule for administrative override.
    match /{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Technician Permissions

    // Technicians can read all technicians' data (for lists, maps) but can't write.
    match /technicians/{techId} {
      allow read: if isTechnician();
    }
    
    // Technicians can read all infrastructure data (for map display, etc) but cannot write.
    match /infrastructure/{deviceId} {
      allow read: if isTechnician();
    }
    
     // Technicians can read all users' data (needed for name lookups etc.) but can't write.
    match /users/{userId} {
      allow read: if isTechnician();
    }
    
    // Technicians can read all tasks, but can only update a task assigned to them.
    match /tasks/{taskId} {
      allow read: if isTechnician();
      // Allow a tech to update a task if it is assigned to them
      allow update: if isTechnician() && resource.data.tech_id == request.auth.uid;
    }
    
    // Technicians can read all connections for map display
    match /connections/{connId} {
      allow read: if isTechnician();
    }
    
    // Technicians can read all alerts
    match /alerts/{alertId} {
      allow read: if isTechnician();
    }
    
    // Technicians can read all materials (to know what's available)
    match /materials/{materialId} {
      allow read: if isTechnician();
    }

    // Technicians can create new referrals and material requests (assignments)
    match /referrals/{referralId} {
        allow read: if isTechnician(); // Can read their own or all for admins (covered by admin rule)
        allow create: if isTechnician();
    }
    
    match /assignments/{assignmentId} {
        allow read: if isTechnician();
        allow create: if isTechnician(); // For submitting requests
    }
    
    match /plans/{planId} {
        allow read: if isTechnician();
    }
  }
}