
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin role
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }
    
    // Helper function to check for any authenticated user
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if the requesting user is a technician
    function isTechnician() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Technician';
    }

    // Users: Can only read/write their own data. Admin can read all.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isAdmin();
      allow create, delete: if isAdmin();
      
      // Notifications are subcollections of users
       match /notifications/{notificationId} {
        allow read, write: if request.auth.uid == userId; // Users can manage their own notifications
      }
    }

    // Technicians: Authenticated users can read. Admins can write.
    match /technicians/{techId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(); // Only admins can create, update, or delete technicians
    }

    // Tasks: Authenticated can read. Admins can write. Technicians can update their assigned tasks.
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || (isTechnician() && resource.data.tech_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.id);
    }
    
    // Materials: Admins can manage materials. Technicians can read.
    match /materials/{materialId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }
    
    // Assignments: Admins can manage all. Technicians can create (request) and read their own.
    match /assignments/{assignmentId} {
        allow read: if isAuthenticated();
        allow create: if isTechnician();
        allow update, delete: if isAdmin();
    }

    // Alerts: Authenticated can read. Server/Admin can write.
    match /alerts/{alertId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Infrastructure & Connections: Authenticated users can read. Admins can write.
    match /infrastructure/{deviceId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }
    
    match /connections/{connectionId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }
    
    // Referrals: Authenticated can read. Technicians can create. Admins can update/delete.
    match /referrals/{referralId} {
        allow read: if isAuthenticated();
        allow create: if isTechnician();
        allow update, delete: if isAdmin();
    }

    // ProofOfWork: Admins can read/delete. Technicians can create for their own tasks.
    match /proofOfWork/{proofId} {
        allow read, delete: if isAdmin();
        allow create: if isTechnician();
    }
    
    // Settings: Only Admins can read/write
    match /settings/{settingId} {
        allow read, write: if isAdmin();
    }

    // Plans: Only Admins can read/write
    match /plans/{planId} {
        allow read, write: if isAdmin();
    }
    
     // Contact Submissions: Admins can manage. Public can create.
    match /contacts/{contactId} {
      allow create: if true; // Allow public form submission
      allow read, update, delete: if isAdmin();
    }
  }
}
