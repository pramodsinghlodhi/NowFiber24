
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if the user is authenticated.
    function isAuth() {
      return request.auth != null;
    }

    // Helper function to check if the user has an Admin role in their user document.
    // This is the correct way to check roles for client-side queries.
    function isUserAdmin() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    // Users can only read their own profile. Admins can read any profile.
    match /users/{userId} {
      allow read: if isAuth() && (request.auth.uid == userId || isUserAdmin());
      allow write: if isUserAdmin(); // Only admins can create/update user profiles.
      
      // Notifications are a subcollection of users.
      // A user can read, write, and delete their own notifications.
      match /notifications/{notificationId} {
        allow read, write, delete: if isAuth() && request.auth.uid == userId;
      }
    }

    // Admins can read/list all technicians. Authenticated users can read individual documents.
    match /technicians/{techId} {
      allow get: if isAuth();
      allow list: if isUserAdmin();
      allow write: if isUserAdmin(); // Only admins (or server actions) can update technician data.
    }
    
    // Admins can read/list all tasks. Authenticated users can read individual tasks.
    match /tasks/{taskId} {
      allow get: if isAuth();
      allow list: if isUserAdmin();
      allow write: if isUserAdmin(); // Only admins can create/update/delete tasks.
    }
    
    // Admins can read/list all alerts. Authenticated users can read individual alerts.
    match /alerts/{alertId} {
        allow get: if isAuth();
        allow list: if isUserAdmin();
        allow write: if isUserAdmin();
    }
    
    // Any authenticated user can read infrastructure data. Only admins can modify it.
    match /infrastructure/{deviceId} {
        allow read: if isAuth();
        allow write: if isUserAdmin();
    }

    // Any authenticated user can read connection data. Only admins can modify it.
    match /connections/{connectionId} {
      allow read: if isAuth();
      allow write: if isUserAdmin();
    }

    // Any authenticated user can read materials data. Only admins can modify it.
    match /materials/{materialId} {
      allow read: if isAuth();
      allow write: if isUserAdmin();
    }
    
    // Admins can list all assignments. Authenticated users can read individual assignments.
    match /assignments/{assignmentId} {
        allow get: if isAuth();
        allow list: if isUserAdmin();
        allow write: if isUserAdmin(); // Only admins can create/update assignments
        allow create: if isAuth(); // Technicians can create new requests (assignments)
    }

    // Any authenticated user can read referrals. Technicians can create new ones. Admins can update.
    match /referrals/{referralId} {
        allow read: if isAuth();
        allow create: if isAuth();
        allow update: if isUserAdmin();
    }
    
    // Only admins can read or write settings.
    match /settings/{settingId} {
        allow read, write: if isUserAdmin();
    }

    // Only admins can read proof of work submissions.
    match /proofOfWork/{proofId} {
      allow read: if isUserAdmin();
      allow create: if isAuth();
      allow write, delete: if isUserAdmin();
    }

    // Authenticated users can submit to the contact form. Admins can manage submissions.
    match /contacts/{contactId} {
        allow create: if true; // Open for anyone to submit
        allow read, update, delete: if isUserAdmin();
    }
    
  }
}
