
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================
    // Helper Functions
    // =================================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'Admin';
    }

    function isTechnician() {
      return isAuthenticated() && getUserRole() == 'Technician';
    }

    // Check if the requesting user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Check if the requesting user is the assigned technician for a document
    function isAssignedTech(resourceId, fieldName) {
        return request.auth.uid == get(/databases/$(database)/documents/$(resourceId)).data[fieldName];
    }

    // =================================
    // Collection Rules
    // =================================

    // Users Collection
    match /users/{userId} {
      // Admins can manage any user document.
      allow read, write: if isAdmin();
      // Users can only read their own profile. They cannot edit it directly.
      allow get: if isOwner(userId);
    }
    
    // Technicians Collection
    match /technicians/{techId} {
      // Admins can manage all technician documents.
      allow read, write: if isAdmin();
      // All authenticated users can read technician info (for maps etc.)
      allow get, list: if isAuthenticated();
      // A technician can only update their own document.
      allow update: if isOwner(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.id);
    }

    // Alerts Collection
    match /alerts/{alertId} {
        // Admins can manage alerts
        allow write: if isAdmin();
        // All authenticated users can read alerts
        allow read: if isAuthenticated();
    }
    
    // Tasks Collection
    match /tasks/{taskId} {
      // Admins can manage all tasks
      allow write: if isAdmin();
      // All authenticated users can read tasks
      allow read: if isAuthenticated();
      // A technician can update a task assigned to them
      allow update: if isTechnician() && request.auth.uid == resource.data.tech_id;
    }

    // Inventory Collection
    match /infrastructure/{deviceId} {
        // Admins can manage all infrastructure
        allow write: if isAdmin();
        // All authenticated users can read inventory data
        allow read: if isAuthenticated();
    }
    
    // Connections Collection
    match /connections/{connectionId} {
        allow write: if isAdmin();
        allow read: if isAuthenticated();
    }

    // Materials Collection
    match /materials/{materialId} {
      // Admins can manage materials stock
      allow write: if isAdmin();
      // All authenticated users can read the material list
      allow read: if isAuthenticated();
    }

    // Assignments Collection
    match /assignments/{assignmentId} {
        // Admins can manage all assignments
        allow write: if isAdmin();
        // Technicians can create new requests (assignments)
        allow create: if isTechnician();
        // All authenticated users can read assignments (for viewing their status)
        allow read: if isAuthenticated();
    }
    
    // Referrals Collection
    match /referrals/{referralId} {
        // Admins can manage all referrals
        allow write: if isAdmin();
        // Technicians can create new referrals
        allow create: if isTechnician();
        // All authenticated users can read referral data
        allow read: if isAuthenticated();
    }

    // Plans Collection (Read-only for now)
    match /plans/{planId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }
  }
}
