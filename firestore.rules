rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user has a specific role
    function hasRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // Helper function to check if a user is the owner of a document (based on tech_id)
    function isOwner(doc) {
        return request.auth.uid == get(/databases/$(database)/documents/users/$(doc.data.tech_id)).data.uid;
    }

    // Admins can read and write anything
    match /{path=**} {
        allow read, write: if hasRole('Admin');
    }

    // Users collection:
    // - Authenticated users can read their own user document.
    // - Admins can read/write any user document.
    match /users/{userId} {
      allow get: if request.auth.uid == userId || hasRole('Admin');
      allow read, write: if hasRole('Admin');
    }

    // Technicians collection:
    // - Authenticated users can read all technician data (for maps, lists, etc.)
    // - Admins can write to any technician document.
    match /technicians/{techId} {
        allow read: if request.auth.token.email != null;
        allow write: if hasRole('Admin');
    }
    
    // Tasks collection:
    // - Authenticated users can read all tasks.
    // - Technicians can update a task assigned to them.
    // - Admins can write to any task document.
    match /tasks/{taskId} {
        allow read: if request.auth.token.email != null;
        allow create, delete: if hasRole('Admin');
        allow update: if hasRole('Admin') || (hasRole('Technician') && isOwner(resource));
    }
    
    // Infrastructure, Connections, Alerts, Materials, Plans
    // - Authenticated users can read all these collections.
    // - Only Admins can write to them.
    match /(infrastructure|connections|alerts|materials|plans)/{docId} {
        allow read: if request.auth.token.email != null;
        allow write: if hasRole('Admin');
    }
    
    // Assignments (Material Requests)
    // - Authenticated users can read all assignments.
    // - Technicians can create their own assignments (make requests).
    // - Admins can update or delete any assignment.
    match /assignments/{assignmentId} {
        allow read: if request.auth.token.email != null;
        allow create: if hasRole('Technician');
        allow update, delete: if hasRole('Admin');
    }
    
    // Referrals
    // - Authenticated users can read all referrals.
    // - Technicians can create their own referrals.
    // - Admins can update or delete any referral.
    match /referrals/{referralId} {
        allow read: if request.auth.token.email != null;
        allow create: if hasRole('Technician');
        allow update, delete: if hasRole('Admin');
    }
  }
}
