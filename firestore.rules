
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Technicians can update their own location and status. Admins can do anything.
    match /technicians/{techId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == techId || request.auth.token.role == 'Admin';
    }

    // Users can only read their own profile. Admins can read all profiles.
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || request.auth.token.role == 'Admin');
      allow write: if request.auth != null && request.auth.uid == userId; // Allow users to update their own profile.
      allow list: if request.auth != null && request.auth.token.role == 'Admin'; // Allow admins to list users.
    }

    // Authenticated users can read most data. Writing is restricted to Admins.
    match /{document=**} {
      allow read: if request.auth != null;
    }

    // Write access is generally restricted to Admins, with specific exceptions below.
    match /{path=**}/ {
      allow write: if request.auth != null && request.auth.token.role == 'Admin';
    }
    
    // Technicians can create new referrals.
    match /referrals/{referralId} {
        allow create: if request.auth != null;
    }
    
    // Technicians can create Proof of Work documents
    match /proofOfWork/{proofId} {
        allow create: if request.auth != null;
    }

    // Technicians can request materials (create new assignments)
    match /assignments/{assignmentId} {
        allow create: if request.auth != null;
        allow update: if request.auth != null && request.auth.token.role == 'Admin';
    }

    // Tasks can be updated by the assigned tech or an admin.
    match /tasks/{taskId} {
        allow update: if request.auth.uid == resource.data.tech_id || request.auth.token.role == 'Admin';
    }
  }
}
