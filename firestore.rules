
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isRole(role) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    // Admins can read and write anything
    match /{document=**} {
      allow read, write: if isRole('Admin');
    }
    
    // Users Collection
    match /users/{userId} {
      // Any signed-in user can create their own profile (should be handled by admin for this app)
      // A user can read their own profile, or an admin can
      allow read: if isSignedIn() && (isOwner(userId) || isRole('Admin'));
      // Only an admin can create or update user profiles
      allow create, update: if isRole('Admin');
      // Only an admin can delete users
      allow delete: if isRole('Admin');
    }

    // Technicians Collection
    match /technicians/{techId} {
        // Any signed-in user can read technician info
        allow read: if isSignedIn();
        // Only admins can create/update technician profiles
        allow create, update, delete: if isRole('Admin');
    }

    // Tasks Collection
    match /tasks/{taskId} {
        allow read: if isSignedIn();
        // Techs can update their own tasks, Admins can create/update/delete any
        allow update: if isSignedIn() && (isRole('Admin') || get(/databases/$(database)/documents/tasks/$(taskId)).data.tech_id == request.auth.uid);
        allow create, delete: if isRole('Admin');
    }

    // Alerts, Infrastructure, Connections, Referrals, Materials, Assignments, ProofOfWork, Plans
    match /alerts/{alertId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isRole('Admin');
    }
    match /infrastructure/{deviceId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isRole('Admin') || isRole('Technician');
    }
    match /connections/{connectionId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isRole('Admin');
    }
    match /referrals/{referralId} {
        allow read: if isSignedIn();
        allow create: if isRole('Technician');
        allow update, delete: if isRole('Admin');
    }
     match /materials/{materialId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isRole('Admin');
    }
     match /assignments/{assignmentId} {
        allow read: if isSignedIn();
        allow create: if isRole('Admin') || isRole('Technician');
        allow update, delete: if isRole('Admin');
    }
     match /proofOfWork/{proofId} {
        allow read: if isSignedIn();
        allow create: if isRole('Technician');
        allow delete: if isRole('Admin');
    }
     match /plans/{planId} {
        allow read: if isRole('Admin');
        allow create, update, delete: if isRole('Admin');
    }
     match /settings/{settingId} {
        allow read: if isRole('Admin');
        allow update: if isRole('Admin');
     }
     match /contacts/{contactId} {
        // Public can write
        allow create;
        // Admins can manage
        allow read, update, delete: if isRole('Admin');
     }
     
     // Notifications Subcollection
     match /users/{userId}/notifications/{notificationId} {
        // A user can manage their own notifications
        allow read, update, delete: if isOwner(userId);
        allow create: if isRole('Admin'); // Only server/admin can create notifications
     }
  }
}

    