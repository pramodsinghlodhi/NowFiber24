{
  "rules": {
    "rules_version": "2",
    "service": "cloud.firestore",
    "match": "/databases/{database}/documents" {
    
      // Helper function to check if the user is an admin
      function isAdmin() {
        return request.auth != null && request.auth.token.isAdmin == true;
      }

      // Helper function to check if the user is a logged-in technician
      function isTechnician() {
        return request.auth != null && request.auth.token.role == 'Technician';
      }
      
      // Helper function to check if the user is authenticated
      function isAuthenticated() {
        return request.auth != null;
      }

      // Users can only manage their own profile
      "match": "/users/{userId}" {
        "allow read, update": "if request.auth.uid == userId || isAdmin();",
        "allow create, delete": "if isAdmin();" // Only admins can create/delete users via backend
      }
      
      // Users can only access their own notifications
      "match": "/users/{userId}/notifications/{notificationId}" {
        "allow read, write": "if request.auth.uid == userId;"
      }
      
      "match": "/settings/live" {
        "allow read": "if isAuthenticated();",
        "allow write": "if isAdmin();"
      }

      // All authenticated users can read technician data, but only admins can write
      "match": "/technicians/{technicianId}" {
        "allow read": "if isAuthenticated();",
        "allow write": "if isAdmin();"
      }

      // Tasks can be read by all, but only managed by admins or the assigned technician
      "match": "/tasks/{taskId}" {
        "allow read": "if isAuthenticated();",
        "allow create": "if isAdmin();",
        "allow update": "if isAdmin() || (isTechnician() && resource.data.tech_id == request.auth.token.sub);"
      }

      // Alerts can be read by all, only created/managed by admins (or server-side functions)
       "match": "/alerts/{alertId}" {
        "allow read": "if isAuthenticated();",
        "allow write": "if isAdmin();"
      }
      
      // All authenticated users can read infrastructure, but only admins/techs can write (add new devices)
      "match": "/infrastructure/{deviceId}" {
        "allow read": "if isAuthenticated();",
        "allow write": "if isAdmin() || isTechnician();"
      }
      
      "match": "/connections/{connectionId}" {
        "allow read": "if isAuthenticated();",
        "allow write": "if isAdmin();"
      }

      "match": "/materials/{materialId}" {
        "allow read": "if isAuthenticated();",
        "allow write": "if isAdmin();"
      }

      "match": "/assignments/{assignmentId}" {
        "allow read": "if isAuthenticated();",
        // Admins can create/update. Techs can create (request)
        "allow create": "if isAuthenticated();",
        "allow update": "if isAdmin();"
      }

      "match": "/referrals/{referralId}" {
        // Techs can create their own. Admins can manage all.
        "allow read": "if isAuthenticated();",
        "allow create": "if isTechnician();",
        "allow update": "if isAdmin();"
      }

      "match": "/proofOfWork/{proofId}" {
         // Techs can create their own. Admins can read/delete all.
        "allow read": "if isAdmin();",
        "allow create": "if isTechnician();",
        "allow delete": "if isAdmin();"
      }

      "match": "/plans/{planId}" {
        "allow read": "if isAuthenticated();",
        "allow write": "if isAdmin();"
      }
    }
  }
}
